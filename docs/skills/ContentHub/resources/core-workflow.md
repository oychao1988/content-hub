# 核心工作流定义

本文档定义通用内容运营框架的详细执行步骤。

## 工作流概览

```
工作流0: 创建新账号
├── 检查账号是否存在
├── 引导用户定义账号
├── 自动生成账号文件夹和配置文件
└── 引导用户完善配置

工作流1: 基于现有账号生成内容
├── Step 0: 加载账号配置
├── Step 1: 选题模块（可选）
├── Step 2: 内容生成模块（核心）
├── Step 3: 配图模块（可选）
├── Step 4: 质量检查模块（可选）
└── Step 5: 更新执行状态
```

## 工作流0：创建新账号

### 详细步骤

#### 0.1 检查账号是否存在

**输入**：账号名称（用户提供）

**动作**：
1. 在项目根目录查找 `{账号名称}/` 文件夹
2. 如果存在，提示用户账号已存在，询问是否重新配置
3. 如果不存在，继续创建流程

**输出**：布尔值（是否存在）

#### 0.2 引导用户定义账号

**输入**：用户意图

**动作**：
1. 询问账号名称
2. 询问账号类型：
   - 提供默认风格库选项（技术博客/营销文案/美食评论/新闻媒体）
   - 提供"自定义"选项
3. 询问账号定位（一句话描述）
4. 询问目标受众
5. 询问需要启用的模块（选题/生成/配图/质检）

**输出**：账号配置信息

#### 0.3 自动生成账号文件夹和配置文件

**输入**：账号配置信息

**动作**：
```bash
# 创建目录结构
mkdir -p "{账号名称}/output"
mkdir -p "{账号名称}/assets/brand-assets"
```

复制模板文件并生成：
- **核心文件（必选）**：
  - `account-config.md`：基于 `resources/config-templates/account-config-template.md`
  - `writing-style.md`：基于选择的类型从 `resources/default-styles/` 复制
  - `content-structure.md`：基于 `resources/config-templates/content-structure-template.md`
  - `content-plan.md`：基于 `resources/config-templates/content-plan-template.md`
  - `{账号名称}/output/current-run-status.md`：基于 `current-run-status-template.md`
- **模块文件（可选，基于选配模块生成）**：
  - **选题模块**：生成 `data-sources.md` 和 `{账号名称}/output/topic-history.md`
  - **发布模块**：生成 `publish-config.md` 和 `.env.{账号名称}`

**输出**：基于选配生成的账号文件夹结构和配置文件

#### 0.4 引导用户完善配置

**输入**：生成的配置文件

**动作**：
1. 提示用户检查生成的配置文件
2. 特别强调 `content-structure.md`，引导用户规划内容板块
3. 提供编辑建议

**输出**：完成提示

## 工作流1：基于现有账号生成内容

### Step 0：加载账号配置

#### 0.1 读取账号文件夹

**输入**：账号名称

**动作**：
1. 验证账号文件夹存在
2. 验证4个配置文件都存在
3. 如果缺少文件，提示用户补全

**输出**：账号文件夹路径

#### 0.2 加载配置文件

**输入**：账号文件夹路径

**动作**：
1. 读取 `account-config.md`
   - 提取工作流配置（启用的模块）
   - 提取输出配置
   - 提取板块列表
2. 读取 `writing-style.md`
   - 提取语言风格
   - 提取字数标准
   - 提取表达规范
3. 读取 `content-structure.md`
   - 提取板块定义
   - 提取结构规则
4. 加载 `content-plan.md`
   - 提取待兑现预告
   - 提取连载计划
5. 如果启用选题模块，读取 `data-sources.md`
6. 如果启用发布模块，读取 `publish-config.md`

**输出**：账号配置对象（包含所有模块状态和规则）

#### 0.3 初始化执行状态

**输入**：账号配置

**动作**：
1. 复制 `resources/config-templates/current-run-status-template.md`
2. 生成 `{账号}/output/current-run-status.md`
3. 填入执行日期和时间

**输出**：执行状态文件

### Step 1：选题模块（可选）

**触发条件**：`account-config.md` 中启用了选题模块

#### 1.1 读取信息源列表

**输入**：`data-sources.md`

**动作**：
1. 提取监控站点列表
2. 提取选题策略（数量、周期）
3. 提取评分标准（维度、权重）

**输出**：信息源列表和评分规则

#### 1.2 逐个检索信息源

**输入**：信息源列表

**动作**：
对每个站点：
1. 使用 MCP 工具（tavily-mcp）检索最新内容
2. 提取新闻标题、URL、关键要点
3. 评估适合哪个板块

**输出**：候选选题清单

#### 1.3 评分筛选

**输入**：候选选题清单、评分规则

**动作**：
1. 对每个候选选题进行多维度打分
2. 计算总分
3. 按板块归类
4. 选择总分最高的选题

**输出**：最终选题列表

#### 1.4 记录选题历史

**输入**：最终选题列表

**动作**：
1. 读取 `{账号}/output/topic-history.md`
2. 如果不存在，基于 `topic-history-template.md` 创建
3. 在顶部插入今日选题记录
4. 清理过期的快讯新闻（如7天前）

**输出**：更新后的选题历史

### Step 2：内容生成模块（核心）

#### 2.1 确定生成参数

**输入**：用户请求、账号配置、内容计划

**动作**：
1. 确定板块（用户指定或自动选择）
2. **检查待兑现预告**：
   - 扫描 `content-plan.md` 中的“待兑现的预告”
   - 如果存在匹配今日日期的预告，优先选择该预告作为选题
3. 确定选题（用户提供、从预告确定或从选题列表选择）
4. 从 `content-structure.md` 读取该板块的结构定义
5. 从 `writing-style.md` 读取风格要求

**输出**：生成参数对象

#### 2.2 生成文章内容

**输入**：生成参数

**动作**：
1. 按照板块结构定义生成内容
2. 遵循必选/可选模块规则
3. 应用写作风格（语气、人设、表达规范）
4. 控制字数在规定范围内
5. 预留图片位置（如果启用配图）

**输出**：文章 Markdown 内容

#### 2.3 输出文章

**输入**：文章内容、输出配置

**动作**：
1. 创建 `{账号}/output/{日期}/` 目录
2. 按文件命名规则保存文章
3. 如果启用配图，创建 `{账号}/output/{日期}/images/` 目录
4. 统计字数，确认在范围内

**输出**：文章文件路径

### Step 3：配图模块（可选）

**触发条件**：`account-config.md` 中启用了配图模块

#### 3.1 分析配图需求

**输入**：文章内容、板块定义

**动作**：
1. 提取文章关键词
2. 识别核心冲突/案例
3. 确定情感基调
4. 动态确定配图数量（基于字数和内容复杂度）

**输出**：配图方案

#### 3.2 生成配图

**输入**：配图方案

**动作**：
对每张图片：
1. 编写 Prompt（基于内容分析 + 板块风格）
2. 调用豆包AI生成图片
3. 下载到 `{账号}/output/{日期}/images/`
4. 验证文件大小和质量
5. 更新文章中的图片引用

**输出**：图片文件列表

### Step 4：质量检查模块（可选）

**触发条件**：`account-config.md` 中启用了质量检查模块

#### 4.1 执行质量门禁

**输入**：文章内容、账号配置

**动作**：
1. **结构检查**：验证所有必选模块都存在
2. **字数检查**：验证字数在规定范围内
3. **风格检查**：验证符合写作风格要求
4. **事实核查**：验证关键数据有来源标注

**输出**：质量检查结果

#### 4.2 调整内容（如果需要）

**输入**：质量检查结果

**动作**：
如果检查不通过：
1. 根据问题类型调整内容
2. 重新执行质量检查
3. 最多重试3次

**输出**：最终文章内容

### Step 5：内容发布模块（可选）

**触发条件**：`account-config.md` 中启用了发布模块

#### 5.1 发布前合规检查

**输入**：最终文章内容、发布配置

**动作**：
1. **格式检查**：验证 YAML Front Matter 是否包含正确的 `title` 和 `cover`
2. **路径检查**：文章内图片引用保持相对路径（`./images/{文件名}`）；发布前生成 publish-ready 文件，将图片引用（含 `cover`）转换为本地绝对路径并校验存在性
3. **内容检查**：检查是否有未替换的占位符或明显的 AI 生成痕迹

**输出**：合规检查结果

#### 5.2 执行发布

**输入**：检查通过的文章（publish-ready）

**动作**：
1. 读取 publish-ready 文件内容（由 5.1 生成），作为发布输入
2. 调用 MCP 发布工具（如 `wenyan-mcp`）
2. 选择配置的主题（或根据板块自动匹配）
3. 执行发布到草稿箱（默认）或直接发布

**输出**：发布结果（URL/状态）

### Step 6：更新状态与计划

**输入**：所有步骤的执行结果

**动作**：
1. 更新 `{账号}/output/current-run-status.md`
2. 标记完成的任务
3. 记录通过的质量门禁
4. 记录遇到的问题和解决方案
5. **更新内容计划**：
   - 如果发布成功且该内容对应某个预告，将其从 `content-plan.md` 的“待兑现”移动到“已发布”
6. 统计输出文件清单

**输出**：最终执行状态

## 错误处理

### 账号不存在

**处理**：提示用户账号不存在，引导创建新账号

### 配置文件缺失

**处理**：提示用户补全缺失的配置文件

### 配置文件格式错误

**处理**：提示具体的格式错误，建议检查 Markdown 语法

### 选题失败

**处理**：
1. 尝试备用信息源
2. 降低选题标准
3. 3次失败后提示用户手动指定选题

### 生成内容不满足字数要求

**处理**：
1. 调整内容长度（增加或删减）
2. 最多重试3次

### 配图生成失败

**处理**：
1. 优化 Prompt
2. 简化 Prompt
3. 3次失败后跳过该图片

### 质量检查不通过

**处理**：
1. 调整内容
2. 最多重试3次
3. 仍不通过则生成警告，但仍输出内容

## 输入输出规范

### 输入格式

**创建账号**：
```
"创建一个{账号类型}账号，名称叫{账号名称}"
```

**生成内容**：
```
"用{账号名称}账号，生成{板块}{选题}"
"用{账号名称}账号，从监控站点检索今日新闻并生成{板块}"
```

### 输出格式

**成功**：
```
✅ 已创建账号 {账号名称}
📁 账号文件夹：{账号名称}/
📝 配置文件：account-config.md, writing-style.md, content-structure.md, data-sources.md
💡 下一步：编辑配置文件，规划内容板块
```

```
✅ 已生成文章
📄 文件路径：{账号}/output/{日期}/{文件名}.md
📊 字数统计：{字数}字
🖼️ 配图数量：{数量}张
```

**失败**：
```
❌ 错误：{错误信息}
💡 建议：{解决建议}
```
